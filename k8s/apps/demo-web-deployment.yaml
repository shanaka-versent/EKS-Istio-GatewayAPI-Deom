# MTKC POC EKS - Demo Web Application
# @author Shanaka Jayasundera - shanakaj@gmail.com
#
# LAYER 4: Application Deployment (ArgoCD)
# This app demonstrates static assets served from S3 via CloudFront.
# - HTML pages served from K8s pods (via ALB -> CloudFront)
# - Static assets (CSS, JS, images) served from S3 (via CloudFront)

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-web
  namespace: sample-apps
  labels:
    app: demo-web
spec:
  replicas: 2
  selector:
    matchLabels:
      app: demo-web
  template:
    metadata:
      labels:
        app: demo-web
        version: v1
    spec:
      containers:
        - name: nginx
          image: nginx:1.27-alpine
          ports:
            - containerPort: 8080
              name: http
          command: ["/bin/sh", "-c"]
          args:
            - |
              mkdir -p /usr/share/nginx/html

              # Create index.html that references CloudFront-served static assets
              cat > /usr/share/nginx/html/index.html << 'HTML_EOF'
              <!DOCTYPE html>
              <html lang="en">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>MTKC POC - EKS + Istio + Gateway API</title>
                  <!-- CSS served from S3 via CloudFront -->
                  <link rel="stylesheet" href="/static/css/styles.css">
              </head>
              <body>
                  <div class="container">
                      <header class="header">
                          <!-- Logo served from S3 via CloudFront -->
                          <img src="/static/images/logo.svg" alt="MTKC POC Logo" style="height: 60px; margin-bottom: 15px;">
                          <h1>MTKC POC Demo</h1>
                          <p>EKS + Istio Ambient Mesh + Kubernetes Gateway API</p>
                      </header>

                      <div class="card">
                          <h2>Architecture Demonstration</h2>
                          <div class="info-grid">
                              <div class="info-item">
                                  <strong>HTML Page</strong>
                                  Served from K8s pods via ALB
                              </div>
                              <div class="info-item">
                                  <strong>Static Assets</strong>
                                  Served from S3 via CloudFront CDN
                              </div>
                              <div class="info-item">
                                  <strong>Service Mesh</strong>
                                  Istio Ambient (no sidecars)
                              </div>
                              <div class="info-item">
                                  <strong>API Gateway</strong>
                                  AWS API Gateway via ACK
                              </div>
                          </div>
                      </div>

                      <div class="card">
                          <h2>Static Asset Sources</h2>
                          <p>The following assets are cached and served globally via CloudFront:</p>
                          <ul style="margin-top: 10px; padding-left: 20px;">
                              <li><code>/static/css/styles.css</code> - CSS stylesheet from S3</li>
                              <li><code>/static/js/app.js</code> - JavaScript from S3</li>
                              <li><code>/static/images/logo.svg</code> - Logo image from S3</li>
                          </ul>
                          <div id="static-info" class="info-grid" style="margin-top: 15px;"></div>
                      </div>

                      <div class="card">
                          <h2>Traffic Flow</h2>
                          <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">
              Client Request
                    |
                    v
              CloudFront + WAF (Edge)
                    |
              +-----+-----+
              |           |
              v           v
              S3        ALB (Internal)
              (static)      |
                            v
                      Internal NLB
                            |
                            v
                      Istio Gateway
                            |
                            v
                      K8s Services
                          </pre>
                      </div>

                      <div class="card">
                          <h2>Server Information</h2>
                          <div class="info-grid">
                              <div class="info-item">
                                  <strong>Pod Name</strong>
                                  <span id="pod-name">Loading...</span>
                              </div>
                              <div class="info-item">
                                  <strong>Namespace</strong>
                                  sample-apps
                              </div>
                              <div class="info-item">
                                  <strong>Timestamp</strong>
                                  <span id="load-timestamp">Loading...</span>
                              </div>
                          </div>
                      </div>

                      <footer class="footer">
                          <p>MTKC POC - AWS EKS with Istio Gateway API</p>
                          <p>Author: Shanaka Jayasundera</p>
                      </footer>
                  </div>

                  <!-- JavaScript served from S3 via CloudFront -->
                  <script src="/static/js/app.js"></script>
              </body>
              </html>
              HTML_EOF

              # Create nginx config
              cat > /etc/nginx/conf.d/default.conf << 'NGINX_EOF'
              server {
                  listen 8080;
                  server_name _;

                  root /usr/share/nginx/html;
                  index index.html;

                  location /demo {
                      alias /usr/share/nginx/html;
                      index index.html;
                      try_files $uri $uri/ /index.html;
                  }

                  location /demo/health {
                      default_type text/plain;
                      return 200 'healthy\n';
                  }

                  location /demo/info {
                      default_type application/json;
                      return 200 '{"app":"demo-web","version":"1.0","namespace":"sample-apps","feature":"cloudfront-static-assets"}\n';
                  }

                  location / {
                      try_files $uri $uri/ /index.html;
                  }
              }
              NGINX_EOF
              nginx -g 'daemon off;'
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 64Mi
          livenessProbe:
            httpGet:
              path: /demo/health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /demo/health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: demo-web
  namespace: sample-apps
  labels:
    app: demo-web
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8080
      name: http
  selector:
    app: demo-web
